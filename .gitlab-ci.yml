image: fedora:34

variables:
  DEPENDENCIES: dnf-command(builddep) meson git vala
                bison bison-devel bison-runtime
                glib2-devel gobject-introspection-devel
                libgsf-devel libgcab1-devel
                redhat-rpm-config
                perl-XML-XPath
                diffutils

build_stable:
  before_script:
    - rm -f /etc/rpm/macros.image-language-conf
    - dnf update -y --nogpgcheck
    - dnf install -y --nogpgcheck $DEPENDENCIES
    - dnf builddep -y --nogpgcheck msitools
    - git submodule update --init --recursive
  script:
    - meson _build -Dvalidate-wxi=false # FIXME: revert this once rawhide is fixed
    - ninja -C _build
    - ninja -C _build test
  artifacts:
    paths:
      - _build/meson-logs/*.txt
    when: always
    expire_in: 1 week
